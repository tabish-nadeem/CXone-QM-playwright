import { Given, When, Then, BeforeAll, AfterAll } from "cucumber";
import { BrowserContext, Page, expect, chromium } from "@playwright/test";
import { GlobalTenantUtils } from "../../../../common/globalTenantUtils";
import { CommonQMNoUIUtils } from "../../../../common/CommonQMNoUIUtils"
import { LoginPage } from "../../../../common/login";
import { FEATURE_TOGGLES } from "../../../../common/uiConstants"
import { FormAreaComponentPo } from "../../../../pageObjects/form-area.component.po";
import { ManageFormsPO } from "../../../../pageObjects/manage-forms.po";
import FormDesignerPagePO from '../../../../pageObjects/form-designer-page.po';
import { DesignerToolbarComponentPO } from '../../../../pageObjects/designer-toolbar.component.po'
import { TestFormModalComponentPo } from '../../../../pageObjects/test-form-modal.component.po'
import { ScoringModalComponentPo } from "../../../../pageObjects/scoring-modal.component.po"
import { OnPrepare } from "../../../../playwright.config";
import * as moment from 'moment';

let browser: any,
    page: Page,
    userDetails: any,
    formDetails: any,
    userToken: any,
    formDesignerPage: any,
    formArea: any,
    manageFormsPO: any,
    designerToolbarComponentPO: any,
    testFormModalComponentPo: any,
    scoringModalComponentPo: any,
    loginPage: any,
    newOnPrepare: any,
    newGlobalTenantUtils: any;
let context: BrowserContext;
let formNames = [
    'ImageUpload_1' + moment(),
    'ImageUpload_2' + moment()
];

BeforeAll({ timeout: 300 * 1000 }, async () => {
    browser = await chromium.launch({
        headless: false,
    });
    formDetails = [
        {
            formName: 'SectionScoreFormOne',
            formStatus: 'Draft',
            formType: 'EVALUATION',
            formData: JSON.stringify({formTitle: '', elements: [{ id: 1023322535759, uuid: '11e4b04b-ba9c-42ee-9dca-424d53040cbe', type: 'section', elementData: { sectionElementData: [{ id: 1063100662160, uuid: 'fcc57e93-dd71-4f56-bfb0-ae5d743c5d76', type: 'yesno', elementData: { attributes: { visible: true, question: 'Set question', fontStyling: { font: 'OpenSans', fontSize: 14, fontColor: '#000000', fontIndent: 'left', bold: { isLabelBold: true, fontWeight: 'bold' }, italic: { isLabelItalic: false, fontStyle: 'normal' }, underline: { isLabelUnderline: false, textDecoration: 'none' } }, isScorable: true, appliedRuleCount: 0, elementType: 'yes/no', maxScore: 1, answer: '', required: false, layout: 'vertical', showErrorMsg: false, logic: true, subText: '', choiceList: [{ label: 'Yes', value: '1', criticalQuestionCorrectChoice: true, score: 1, $$hashKey: 'object:1169' }, { label: 'No', value: '2', criticalQuestionCorrectChoice: true, score: 0, $$hashKey: 'object:1170' }], isCritical: false, isScoringEnabledForQuestion: true, questionHTML: 'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6J09wZW5TYW5zJztmb250LXNpemU6IDE0cHg7Y29sb3I6IzAwMDAwMDsiPlNldCBxdWVzdGlvbjwvc3Bhbj48L3N0cm9uZz48L3A+', numbering: '1.1', showNumbering: true, showNumberingDot: false } }, $$hashKey: 'object:1138' }, { id: 1029852632663, uuid: 'd1c64a16-eb3f-4b0d-ad67-172fddead991', type: 'checkbox', elementData: { attributes: { visible: true, question: 'Set question', fontStyling: { font: 'OpenSans', fontSize: 14, fontColor: '#000000', fontIndent: 'left', bold: { isLabelBold: true, fontWeight: 'bold' }, italic: { isLabelItalic: false, fontStyle: 'normal' }, underline: { isLabelUnderline: false, textDecoration: 'none' } }, isScorable: true, appliedRuleCount: 0, elementType: 'checkbox', maxScore: 2, answer: [], required: false, layout: 'vertical', showErrorMsg: false, logic: true, subText: '', choiceList: [{ label: 'Choice 1', value: '1', criticalQuestionCorrectChoice: true, score: 1, selected: false, $$hashKey: 'object:1173' }, { label: 'Choice 2', value: '2', criticalQuestionCorrectChoice: true, score: 1, selected: false, $$hashKey: 'object:1174' }], isCritical: false, isScoringEnabledForQuestion: true, questionHTML: 'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6J09wZW5TYW5zJztmb250LXNpemU6IDE0cHg7Y29sb3I6IzAwMDAwMDsiPlNldCBxdWVzdGlvbjwvc3Bhbj48L3N0cm9uZz48L3A+', numbering: '1.2', showNumbering: true, showNumberingDot: false } }, $$hashKey: 'object:1139' }], attributes: { isScorable: false, question: 'Set Title', backgroundColor: '#ffffff', fontStyling: { font: 'OpenSans', fontSize: 18, fontColor: '#5b788e', fontIndent: 'left', bold: { isLabelBold: false, fontWeight: 'normal' }, italic: { isLabelItalic: false, fontStyle: 'normal' }, underline: { isLabelUnderline: false, textDecoration: 'none' } }, visible: true, appliedRuleCount: 0, questionHTML: 'PHA+PHNwYW4gc3R5bGU9ImZvbnQtZmFtaWx5OidPcGVuU2Fucyc7Zm9udC1zaXplOiAxOHB4O2NvbG9yOiM1Yjc4OGU7Ij5TZXQgVGl0bGU8L3NwYW4+PC9wPg==', numbering: 1, showNumbering: true, showNumberingDot: true } }, $$hashKey: 'object:1114' }, { id: 1074416341945, uuid: '5242bc52-e53e-41d9-87e1-c82bffb7a7f2', type: 'section', elementData: { sectionElementData: [{ id: 1069251090950, uuid: '39da3680-ef12-45ca-abcb-8f02dd33df3d', type: 'radio', elementData: { attributes: { visible: true, question: 'Set question', fontStyling: { font: 'OpenSans', fontSize: 14, fontColor: '#000000', fontIndent: 'left', bold: { isLabelBold: true, fontWeight: 'bold' }, italic: { isLabelItalic: false, fontStyle: 'normal' }, underline: { isLabelUnderline: false, textDecoration: 'none' } }, isScorable: true, appliedRuleCount: 0, elementType: 'radio', maxScore: 1, answer: '', required: false, layout: 'vertical', showErrorMsg: false, logic: true, subText: '', choiceList: [{ label: 'Choice 1', value: '1', criticalQuestionCorrectChoice: true, score: 1, $$hashKey: 'object:1177' }, { label: 'Choice 2', value: '2', criticalQuestionCorrectChoice: true, score: 1, $$hashKey: 'object:1178' }], isCritical: false, isScoringEnabledForQuestion: true, questionHTML: 'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6J09wZW5TYW5zJztmb250LXNpemU6IDE0cHg7Y29sb3I6IzAwMDAwMDsiPlNldCBxdWVzdGlvbjwvc3Bhbj48L3N0cm9uZz48L3A+', numbering: '2.1', showNumbering: true, showNumberingDot: false } }, $$hashKey: 'object:1156' }], attributes: { isScorable: false, question: 'Set Title', backgroundColor: '#ffffff', fontStyling: { font: 'OpenSans', fontSize: 18, fontColor: '#5b788e', fontIndent: 'left', bold: { isLabelBold: false, fontWeight: 'normal' }, italic: { isLabelItalic: false, fontStyle: 'normal' }, underline: { isLabelUnderline: false, textDecoration: 'none' } }, visible: true, appliedRuleCount: 0, questionHTML: 'PHA+PHNwYW4gc3R5bGU9ImZvbnQtZmFtaWx5OidPcGVuU2Fucyc7Zm9udC1zaXplOiAxOHB4O2NvbG9yOiM1Yjc4OGU7Ij5TZXQgVGl0bGU8L3NwYW4+PC9wPg==', numbering: 2, showNumbering: true, showNumberingDot: true } }, $$hashKey: 'object:1115' }], theme: { themeId: '', themeName: '', isDefault: true, themeLogo: '', themeData: { imgWidth: 243, imgHeight: 30, isAspectRatioChecked: true, logoAspectRatio: 8.1, bgColor: '#ffffff', numberingEnabled: true, title: { text: '', font: 'OpenSans', fontSize: 18, fontStyling: { fontColor: '#2e2e2e', italic: { isLabelItalic: false, fontStyle: 'normal' }, bold: { isLabelBold: true, fontWeight: 'bold' }, underline: { isLabelUnderline: false, textDecoration: 'none' } } }, subTitle: { text: '', font: 'OpenSans', fontSize: 14, fontStyling: { fontColor: '#707070', italic: { isLabelItalic: false, fontStyle: 'normal' }, bold: { isLabelBold: false, fontWeight: 'normal' }, underline: { isLabelUnderline: false, textDecoration: 'none' } } } } }, ranking: { isRankingEnabled: false, totalCoverage: 101, ranges: [{ from: '0%', to: '50%', coverage: 51, displayText: 'Failed' }, { from: '51%', to: '100%', coverage: 50, displayText: 'Passed' }] }, themeId: '', elementCount: 5, rules: {}, rulesAssociation: {}, rulesAssociationV2: {},headerFields: [], currentScore: 0, formMaxScore: 4, isFormScoringEnabled: true, percentage: 0}),
            workflowConfigType: 'AGENT_CAN_ACKNOWLEDGE'
        },
        {
            formName: 'SectionScoreFormTwo',
            formStatus: 'Published',
            formType: 'EVALUATION',
            formData: JSON.stringify({formTitle:'',elements:[{id:1081332521274,uuid:'731e3754-e2ff-4300-81bb-f4085f62d7e7',type:'yesno',elementData:{attributes:{visible:true,question:'Set question',fontStyling:{font:'OpenSans',fontSize:14,fontColor:'#000000',fontIndent:'left',bold:{isLabelBold:true,fontWeight:'bold'},italic:{isLabelItalic:false,fontStyle:'normal'},underline:{isLabelUnderline:false,textDecoration:'none'}},isScorable:true,appliedRuleCount:0,elementType:'yes/no',maxScore:1,answer:'',required:false,layout:'vertical',showErrorMsg:false,logic:true,subText:'',choiceList:[{label:'Yes',value:'1',criticalQuestionCorrectChoice:true,score:1,$$hashKey:'object:2866'},{label:'No',value:'2',criticalQuestionCorrectChoice:true,score:0,$$hashKey:'object:2867'}],isCritical:false,isScoringEnabledForQuestion:true,questionHTML:'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6J09wZW5TYW5zJztmb250LXNpemU6MTRweDtjb2xvcjojMDAwMDAwOyI+U2V0IHF1ZXN0aW9uPC9zcGFuPjwvc3Ryb25nPjwvcD4=',numbering:1,showNumbering:true,showNumberingDot:true}},$$hashKey:'object:2841'},{id:1040237633783,uuid:'97228adc-36c9-4a1a-a300-2f079cd50e07',type:'section',elementData:{sectionElementData:[],attributes:{isScorable:false,question:'Set Title',backgroundColor:'#ffffff',fontStyling:{font:'OpenSans',fontSize:18,fontColor:'#5b788e',fontIndent:'left',bold:{isLabelBold:false,fontWeight:'normal'},italic:{isLabelItalic:false,fontStyle:'normal'},underline:{isLabelUnderline:false,textDecoration:'none'}},visible:true,appliedRuleCount:0,questionHTML:'PHA+PHNwYW4gc3R5bGU9ImZvbnQtZmFtaWx5OidPcGVuU2Fucyc7Zm9udC1zaXplOjE4cHg7Y29sb3I6IzViNzg4ZTsiPlNldCBUaXRsZTwvc3Bhbj48L3A+',numbering:2,showNumbering:true,showNumberingDot:true}},$$hashKey:'object:2842'},{id:1025906815704,uuid:'784092f5-9f18-48d4-8fbb-cb21590f32a6',type:'section',elementData:{sectionElementData:[{id:1004676674867,uuid:'cbb2eef4-3abc-4285-be4c-b22487c73ad7',type:'yesno',elementData:{attributes:{visible:true,question:'Set question',fontStyling:{font:'OpenSans',fontSize:14,fontColor:'#000000',fontIndent:'left',bold:{isLabelBold:true,fontWeight:'bold'},italic:{isLabelItalic:false,fontStyle:'normal'},underline:{isLabelUnderline:false,textDecoration:'none'}},isScorable:true,appliedRuleCount:0,elementType:'yes/no',maxScore:1,answer:'',required:false,layout:'vertical',showErrorMsg:false,logic:true,subText:'',choiceList:[{label:'Yes',value:'1',criticalQuestionCorrectChoice:true,score:1,$$hashKey:'object:3033'},{label:'No',value:'2',criticalQuestionCorrectChoice:true,score:0,$$hashKey:'object:3034'}],isCritical:false,isScoringEnabledForQuestion:true,questionHTML:'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6J09wZW5TYW5zJztmb250LXNpemU6MTRweDtjb2xvcjojMDAwMDAwOyI+U2V0IHF1ZXN0aW9uPC9zcGFuPjwvc3Ryb25nPjwvcD4=',numbering:'3.1',showNumbering:true,showNumberingDot:false}},$$hashKey:'object:3016'}],attributes:{isScorable:false,question:'Set Title',backgroundColor:'#ffffff',fontStyling:{font:'OpenSans',fontSize:18,fontColor:'#5b788e',fontIndent:'left',bold:{isLabelBold:false,fontWeight:'normal'},italic:{isLabelItalic:false,fontStyle:'normal'},underline:{isLabelUnderline:false,textDecoration:'none'}},visible:true,appliedRuleCount:0,questionHTML:'PHA+PHNwYW4gc3R5bGU9ImZvbnQtZmFtaWx5OidPcGVuU2Fucyc7Zm9udC1zaXplOjE4cHg7Y29sb3I6IzViNzg4ZTsiPlNldCBUaXRsZTwvc3Bhbj48L3A+',numbering:3,showNumbering:true,showNumberingDot:true}},$$hashKey:'object:3001'},{id:1083579751196,uuid:'a69deaa9-1b94-4884-8c98-5d4eeed3e7d0',type:'section',elementData:{sectionElementData:[{id:1026465334088,uuid:'46cb71dc-2ec9-49a9-9b3f-d500580f0635',type:'yesno',elementData:{attributes:{visible:true,question:'Set question',fontStyling:{font:'OpenSans',fontSize:14,fontColor:'#000000',fontIndent:'left',bold:{isLabelBold:true,fontWeight:'bold'},italic:{isLabelItalic:false,fontStyle:'normal'},underline:{isLabelUnderline:false,textDecoration:'none'}},isScorable:true,appliedRuleCount:0,elementType:'yes/no',maxScore:1,answer:'',required:false,layout:'vertical',showErrorMsg:false,logic:true,subText:'',choiceList:[{label:'Yes',value:'1',criticalQuestionCorrectChoice:true,score:1,$$hashKey:'object:2912'},{label:'No',value:'2',criticalQuestionCorrectChoice:true,score:0,$$hashKey:'object:2913'}],isCritical:false,isScoringEnabledForQuestion:true,questionHTML:'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6J09wZW5TYW5zJztmb250LXNpemU6MTRweDtjb2xvcjojMDAwMDAwOyI+U2V0IHF1ZXN0aW9uPC9zcGFuPjwvc3Ryb25nPjwvcD4=',numbering:'4.1',showNumbering:true,showNumberingDot:false}},$$hashKey:'object:2883'},{id:1044394894548,uuid:'fa45d7c8-e1c7-42d6-9ba2-e7f36d8c30ca',type:'text',elementData:{attributes:{visible:true,appliedRuleCount:0,question:'Set question',fontStyling:{font:'OpenSans',fontSize:14,fontColor:'#000000',fontIndent:'left',bold:{isLabelBold:true,fontWeight:'bold'},italic:{isLabelItalic:false,fontStyle:'normal'},underline:{isLabelUnderline:false,textDecoration:'none'}},isScorable:false,answer:'',required:false,prePopulatedHintText:'',showErrorMsg:false,questionHTML:'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6J09wZW5TYW5zJztmb250LXNpemU6MTRweDtjb2xvcjojMDAwMDAwOyI+U2V0IHF1ZXN0aW9uPC9zcGFuPjwvc3Ryb25nPjwvcD4=',numbering:'4.2',showNumbering:true,showNumberingDot:false}},$$hashKey:'object:2884'},{id:1088891827267,uuid:'1df327d5-9249-4058-a9f0-8fad926f5bac',type:'textarea',elementData:{attributes:{visible:true,appliedRuleCount:0,question:'Set question',fontStyling:{font:'OpenSans',fontSize:14,fontColor:'#000000',fontIndent:'left',bold:{isLabelBold:true,fontWeight:'bold'},italic:{isLabelItalic:false,fontStyle:'normal'},underline:{isLabelUnderline:false,textDecoration:'none'}},isScorable:false,answer:'',required:false,prePopulatedHintText:'',showErrorMsg:false,subText:'',limitCharacters:false,limitCharactersText:250,questionHTML:'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6J09wZW5TYW5zJztmb250LXNpemU6MTRweDtjb2xvcjojMDAwMDAwOyI+U2V0IHF1ZXN0aW9uPC9zcGFuPjwvc3Ryb25nPjwvcD4=',numbering:'4.3',showNumbering:true,showNumberingDot:false}},$$hashKey:'object:2885'}],attributes:{isScorable:false,question:'Set Title',backgroundColor:'#ffffff',fontStyling:{font:'OpenSans',fontSize:18,fontColor:'#5b788e',fontIndent:'left',bold:{isLabelBold:false,fontWeight:'normal'},italic:{isLabelItalic:false,fontStyle:'normal'},underline:{isLabelUnderline:false,textDecoration:'none'}},visible:true,appliedRuleCount:0,questionHTML:'PHA+PHNwYW4gc3R5bGU9ImZvbnQtZmFtaWx5OidPcGVuU2Fucyc7Zm9udC1zaXplOjE4cHg7Y29sb3I6IzViNzg4ZTsiPlNldCBUaXRsZTwvc3Bhbj48L3A+',numbering:4,showNumbering:true,showNumberingDot:true}},$$hashKey:'object:2843'}],theme:{themeId:'',themeName:'',isDefault:true,themeLogo:'',themeData:{imgWidth:243,imgHeight:30,isAspectRatioChecked:true,logoAspectRatio:8.1,bgColor:'#ffffff',numberingEnabled:true,title:{text:'',font:'OpenSans',fontSize:18,fontStyling:{fontColor:'#2e2e2e',italic:{isLabelItalic:false,fontStyle:'normal'},bold:{isLabelBold:true,fontWeight:'bold'},underline:{isLabelUnderline:false,textDecoration:'none'}}},subTitle:{text:'',font:'OpenSans',fontSize:14,fontStyling:{fontColor:'#707070',italic:{isLabelItalic:false,fontStyle:'normal'},bold:{isLabelBold:false,fontWeight:'normal'},underline:{isLabelUnderline:false,textDecoration:'none'}}}}},ranking:{isRankingEnabled:false,totalCoverage:101,ranges:[{from:'0%',to:'50%',coverage:51,displayText:'Failed'},{from:'51%',to:'100%',coverage:50,displayText:'Passed'}]},themeId:'',elementCount:8,rules:{4706406615891:{questionId:1081332521274,operationToPerform:'Hide',resultQuestion:{element:{id:1025906815704,uuid:'784092f5-9f18-48d4-8fbb-cb21590f32a6',type:'section',elementData:{sectionElementData:[{id:1004676674867,type:'yesno',elementData:{attributes:{visible:true,question:'Set question',fontStyling:{font:'OpenSans',fontSize:14,fontColor:'#000000',fontIndent:'left',bold:{isLabelBold:true,fontWeight:'bold'},italic:{isLabelItalic:false,fontStyle:'normal'},underline:{isLabelUnderline:false,textDecoration:'none'}},isScorable:true,appliedRuleCount:0,elementType:'yes/no',maxScore:1,answer:'',required:false,layout:'vertical',showErrorMsg:false,logic:true,subText:'',choiceList:[{label:'Yes',value:'1',criticalQuestionCorrectChoice:true,score:1,$$hashKey:'object:3033'},{label:'No',value:'2',criticalQuestionCorrectChoice:true,score:0,$$hashKey:'object:3034'}],isCritical:false,isScoringEnabledForQuestion:true,questionHTML:'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT1cImZvbnQtZmFtaWx5OidPcGVuU2Fucyc7Zm9udC1zaXplOjE0cHg7Y29sb3I6IzAwMDAwMDtcIj5TZXQgcXVlc3Rpb248L3NwYW4+PC9zdHJvbmc+PC9wPg==',numbering:'3.1',showNumbering:true,showNumberingDot:false}},$$hashKey:'object:3016'}],attributes:{isScorable:false,question:'Set Title',backgroundColor:'#ffffff',fontStyling:{font:'OpenSans',fontSize:18,fontColor:'#5b788e',fontIndent:'left',bold:{isLabelBold:false,fontWeight:'normal'},italic:{isLabelItalic:false,fontStyle:'normal'},underline:{isLabelUnderline:false,textDecoration:'none'}},visible:true,appliedRuleCount:0,questionHTML:'PHA+PHNwYW4gc3R5bGU9XCJmb250LWZhbWlseTonT3BlblNhbnMnO2ZvbnQtc2l6ZToxOHB4O2NvbG9yOiM1Yjc4OGU7XCI+U2V0IFRpdGxlPC9zcGFuPjwvcD4=',numbering:3,showNumbering:true,showNumberingDot:true}},$$hashKey:'object:3001'},label:'3. Set Title'},conditionList:[{operation:{label:'is',value:'==='},choice:{choice:{label:'Yes',value:'1',criticalQuestionCorrectChoice:true,score:1,$$hashKey:'object:2866'},label:'Yes'},$$hashKey:'object:3092'}],ruleExpression:'$ctrl.element.elementData.attributes.answer === "1" && $ctrl.element.elementData.attributes.answer !== ""'},12550417867776:{questionId:1081332521274,isApplied:false,operationToPerform:'Hide',resultQuestion:{element:{id:1026465334088,uuid:'46cb71dc-2ec9-49a9-9b3f-d500580f0635',type:'yesno',elementData:{attributes:{visible:true,question:'Set question',fontStyling:{font:'OpenSans',fontSize:14,fontColor:'#000000',fontIndent:'left',bold:{isLabelBold:true,fontWeight:'bold'},italic:{isLabelItalic:false,fontStyle:'normal'},underline:{isLabelUnderline:false,textDecoration:'none'}},isScorable:true,appliedRuleCount:0,elementType:'yes/no',maxScore:1,answer:'',required:false,layout:'vertical',showErrorMsg:false,logic:true,subText:'',choiceList:[{label:'Yes',value:'1',criticalQuestionCorrectChoice:true,score:1,$$hashKey:'object:2912'},{label:'No',value:'2',criticalQuestionCorrectChoice:true,score:0,$$hashKey:'object:2913'}],isCritical:false,isScoringEnabledForQuestion:true,questionHTML:'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT1cImZvbnQtZmFtaWx5OidPcGVuU2Fucyc7Zm9udC1zaXplOjE0cHg7Y29sb3I6IzAwMDAwMDtcIj5TZXQgcXVlc3Rpb248L3NwYW4+PC9zdHJvbmc+PC9wPg==',numbering:'4.1',showNumbering:true,showNumberingDot:false}},$$hashKey:'object:2883'},label:'4.1 Set question'},conditionList:[{operation:{label:'is',value:'==='},choice:{choice:{label:'No',value:'2',criticalQuestionCorrectChoice:true,score:0,$$hashKey:'object:2867'},label:'No'},$$hashKey:'object:3128'}],ruleExpression:'$ctrl.element.elementData.attributes.answer === "2" && $ctrl.element.elementData.attributes.answer !== ""'}},rulesAssociation:{1026465334088:{rulesToApply:[],rulesForResult:['12550417867776']},1081332521274:{rulesToApply:['4706406615891','12550417867776'],rulesForResult:[]},1025906815704:{rulesToApply:[],rulesForResult:['4706406615891']}},rulesAssociationV2:{},headerFields:[],currentScore:0,formMaxScore:3,isFormScoringEnabled:true,percentage:0}),
            workflowConfigType: 'AGENT_CAN_ACKNOWLEDGE'
        },
        {
            formName: 'SectionScoreFormThree',
            formStatus: 'Published',
            formType: 'EVALUATION',
            formData: JSON.stringify({formTitle: '', elements: [{ id: 1050652215391, uuid: 'fdc19d0b-9adb-40fd-85b7-0f6b82f267af', type: 'section', elementData: { sectionElementData: [{ id: 1021986605833, uuid: '79a56d93-ba36-4347-9294-b06b3433543c', type: 'radio', elementData: { attributes: { visible: true, question: 'Set question', fontStyling: { font: 'OpenSans', fontSize: 14, fontColor: '#000000', fontIndent: 'left', bold: { isLabelBold: true, fontWeight: 'bold' }, italic: { isLabelItalic: false, fontStyle: 'normal' }, underline: { isLabelUnderline: false, textDecoration: 'none' } }, isScorable: true, appliedRuleCount: 0, elementType: 'radio', maxScore: 1, answer: '', required: false, layout: 'vertical', showErrorMsg: false, logic: true, subText: '', choiceList: [{ label: 'Choice 1', value: '1', criticalQuestionCorrectChoice: true, score: 1, $$hashKey: 'object:2146' }, { label: 'Choice 2', value: '2', criticalQuestionCorrectChoice: true, score: 1, $$hashKey: 'object:2147' }], isCritical: false, isScoringEnabledForQuestion: true, questionHTML: 'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6J09wZW5TYW5zJztmb250LXNpemU6MTRweDtjb2xvcjojMDAwMDAwOyI+U2V0IHF1ZXN0aW9uPC9zcGFuPjwvc3Ryb25nPjwvcD4=', numbering: '1.1', showNumbering: true, showNumberingDot: false } }, $$hashKey: 'object:2115' }, { id: 1030636077211, uuid: '08dddac4-82f5-4fd1-b8c2-28d85080ee1e', type: 'yesno', elementData: { attributes: { visible: true, question: 'Set question', fontStyling: { font: 'OpenSans', fontSize: 14, fontColor: '#000000', fontIndent: 'left', bold: { isLabelBold: true, fontWeight: 'bold' }, italic: { isLabelItalic: false, fontStyle: 'normal' }, underline: { isLabelUnderline: false, textDecoration: 'none' } }, isScorable: true, appliedRuleCount: 0, elementType: 'yes/no', maxScore: 1, answer: '', required: false, layout: 'vertical', showErrorMsg: false, logic: true, subText: '', choiceList: [{ label: 'Yes', value: '1', criticalQuestionCorrectChoice: true, score: 1, $$hashKey: 'object:2150' }, { label: 'No', value: '2', criticalQuestionCorrectChoice: true, score: 0, $$hashKey: 'object:2151' }], isCritical: false, isScoringEnabledForQuestion: true, questionHTML: 'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6J09wZW5TYW5zJztmb250LXNpemU6MTRweDtjb2xvcjojMDAwMDAwOyI+U2V0IHF1ZXN0aW9uPC9zcGFuPjwvc3Ryb25nPjwvcD4=', numbering: '1.2', showNumbering: true, showNumberingDot: false } }, $$hashKey: 'object:2116' }], attributes: { isScorable: false, question: 'Set Title', backgroundColor: '#ffffff', fontStyling: { font: 'OpenSans', fontSize: 18, fontColor: '#5b788e', fontIndent: 'left', bold: { isLabelBold: false, fontWeight: 'normal' }, italic: { isLabelItalic: false, fontStyle: 'normal' }, underline: { isLabelUnderline: false, textDecoration: 'none' } }, visible: true, appliedRuleCount: 0, questionHTML: 'PHA+PHNwYW4gc3R5bGU9ImZvbnQtZmFtaWx5OidPcGVuU2Fucyc7Zm9udC1zaXplOjE4cHg7Y29sb3I6IzViNzg4ZTsiPlNldCBUaXRsZTwvc3Bhbj48L3A+', numbering: 1, showNumbering: true, showNumberingDot: true } }, $$hashKey: 'object:2091' }, { id: 1021294679896, uuid: '79d8cd85-f2c6-40af-b610-9293ef775abc', type: 'section', elementData: { sectionElementData: [{ id: 1022194190898, uuid: '9f7b8b94-b566-45dc-b743-5ef452a7eca2', type: 'yesno', elementData: { attributes: { visible: true, question: 'Set question', fontStyling: { font: 'OpenSans', fontSize: 14, fontColor: '#000000', fontIndent: 'left', bold: { isLabelBold: true, fontWeight: 'bold' }, italic: { isLabelItalic: false, fontStyle: 'normal' }, underline: { isLabelUnderline: false, textDecoration: 'none' } }, isScorable: true, appliedRuleCount: 0, elementType: 'yes/no', maxScore: 1, answer: '', required: true, layout: 'vertical', showErrorMsg: false, logic: true, subText: '', choiceList: [{ label: 'Yes', value: '1', criticalQuestionCorrectChoice: true, score: 1, $$hashKey: 'object:2154' }, { label: 'No', value: '2', criticalQuestionCorrectChoice: false, score: 0, $$hashKey: 'object:2155' }], isCritical: true, isScoringEnabledForQuestion: true, questionHTML: 'PHA+PHN0cm9uZz48c3BhbiBzdHlsZT0iZm9udC1mYW1pbHk6J09wZW5TYW5zJztmb250LXNpemU6MTRweDtjb2xvcjojMDAwMDAwOyI+U2V0IHF1ZXN0aW9uPC9zcGFuPjwvc3Ryb25nPjwvcD4=', numbering: '2.1', showNumbering: true, showNumberingDot: false, invalidCriticalQuestion: false } }, $$hashKey: 'object:2133' }], attributes: { isScorable: false, question: 'Set Title', backgroundColor: '#ffffff', fontStyling: { font: 'OpenSans', fontSize: 18, fontColor: '#5b788e', fontIndent: 'left', bold: { isLabelBold: false, fontWeight: 'normal' }, italic: { isLabelItalic: false, fontStyle: 'normal' }, underline: { isLabelUnderline: false, textDecoration: 'none' } }, visible: true, appliedRuleCount: 0, questionHTML: 'PHA+PHNwYW4gc3R5bGU9ImZvbnQtZmFtaWx5OidPcGVuU2Fucyc7Zm9udC1zaXplOjE4cHg7Y29sb3I6IzViNzg4ZTsiPlNldCBUaXRsZTwvc3Bhbj48L3A+', numbering: 2, showNumbering: true, showNumberingDot: true } }, $$hashKey: 'object:2092' }], theme: { themeId: '', themeName: '', isDefault: true, themeLogo: '', themeData: { imgWidth: 243, imgHeight: 30, isAspectRatioChecked: true, logoAspectRatio: 8.1, bgColor: '#ffffff', numberingEnabled: true, title: { text: '', font: 'OpenSans', fontSize: 18, fontStyling: { fontColor: '#2e2e2e', italic: { isLabelItalic: false, fontStyle: 'normal' }, bold: { isLabelBold: true, fontWeight: 'bold' }, underline: { isLabelUnderline: false, textDecoration: 'none' } } }, subTitle: { text: '', font: 'OpenSans', fontSize: 14, fontStyling: { fontColor: '#707070', italic: { isLabelItalic: false, fontStyle: 'normal' }, bold: { isLabelBold: false, fontWeight: 'normal' }, underline: { isLabelUnderline: false, textDecoration: 'none' } } } } }, ranking: { isRankingEnabled: false, totalCoverage: 101, ranges: [{ from: '0%', to: '50%', coverage: 51, displayText: 'Failed' }, { from: '51%', to: '100%', coverage: 50, displayText: 'Passed' }] }, themeId: '', elementCount: 5, rules: {}, rulesAssociation: {}, rulesAssociationV2: {}, headerFields: [], currentScore: 0, formMaxScore: 3, isFormScoringEnabled: true, percentage: 0 }),
            workflowConfigType: 'AGENT_CAN_ACKNOWLEDGE'
        }
    ];
    context = await browser.newContext();
    page = await context.newPage();
    manageFormsPO = new ManageFormsPO(page.locator(`#ng2-manage-forms-page`));
    formDesignerPage = new FormDesignerPagePO();
    formArea = new FormAreaComponentPo();
    designerToolbarComponentPO = new DesignerToolbarComponentPO();
    testFormModalComponentPo =  new TestFormModalComponentPo();
    scoringModalComponentPo = new ScoringModalComponentPo();
    newGlobalTenantUtils = new GlobalTenantUtils();
    userDetails = await newGlobalTenantUtils.getDefaultTenantCredentials();
    newOnPrepare = new OnPrepare();
    loginPage = new LoginPage(page);
    console.log('Form Names used :', formNames);
    userToken = await loginPage.login(userDetails.email, userDetails.password);
    await newOnPrepare.toggleFeatureToggle(FEATURE_TOGGLES.ANGULAR8_MIGRATION_SPRING20, true, userDetails.orgName, userToken)
    await newOnPrepare.toggleFeatureToggle(FEATURE_TOGGLES.RELEASE_NAVIGATION_REDESIGN, true, userDetails.orgName, userToken)
    await manageFormsPO.navigate();
})

AfterAll({ timeout: 60 * 1000 }, async () => {
    await browser.close();
});

Given("should add elements into section and verify section score and form score", { timeout: 60 * 1000 }, async () => {
    await formDesignerPage.navigateTo();
    await formArea.dragElementToFormArea('checkbox');
    await formArea.dragElementToFormArea('section');
    await formArea.dragElementToSection('yesno', '2. Set Title');
    await formArea.dragElementToSection('radio', '2. Set Title');
    await formArea.dragElementToSection('checkbox', '2. Set Title');
    await designerToolbarComponentPO.clickOnScoringButton();
    await scoringModalComponentPo.clickEnableScoring();
    await scoringModalComponentPo.clickQuestionOption('2.2 Set question', 1);
    await scoringModalComponentPo.clickQuestionOption('2.3 Set question', 1);
    expect(await scoringModalComponentPo.getSectionScoreAndPointsValue('2. Set Title')).toEqual(['25', '1 of 4']);
    expect(await scoringModalComponentPo.getCalculatedScore()).toEqual('Calculated weighted score : 17');
    expect(await scoringModalComponentPo.getCurrentPoints()).toEqual('Current points : 1 of 6');
    await scoringModalComponentPo.clickSaveButton();
});

When("should add two sections and verify section score and form score", { timeout: 180 * 1000 }, async () => {
    await CommonQMNoUIUtils.createForm(formDetails[0], userToken);
    await manageFormsPO.navigateToWithWarningModal();
    await manageFormsPO.searchFormInGrid(formDetails[0].formName);
    await manageFormsPO.openParticularForm(formDetails[0].formName);
    await designerToolbarComponentPO.clickOnScoringButton();
    await scoringModalComponentPo.clickQuestionOption('1.1 Set question', 1);
    await scoringModalComponentPo.clickQuestionOption('1.2 Set question', 0);
    await scoringModalComponentPo.clickQuestionOption('1.2 Set question', 1);
    expect(await scoringModalComponentPo.getSectionScoreAndPointsValue('1. Set Title')).toEqual(['67', '2 of 3']);
    expect(await scoringModalComponentPo.getCalculatedScore()).toEqual('Calculated weighted score : 50');
    expect(await scoringModalComponentPo.getCurrentPoints()).toEqual('Current points : 2 of 4');
    expect(await scoringModalComponentPo.getSectionScoreAndPointsValue('2. Set Title')).toEqual(['0', '0 of 1']);
    await scoringModalComponentPo.clickQuestionOption('2.1 Set question', 1);
    expect(await scoringModalComponentPo.getSectionScoreAndPointsValue('2. Set Title')).toEqual(['100', '1 of 1']);
    expect(await scoringModalComponentPo.getCalculatedScore()).toEqual('Calculated weighted score : 75');
    expect(await scoringModalComponentPo.getCurrentPoints()).toEqual('Current points : 3 of 4');
    await scoringModalComponentPo.clickScorableCheckboxOfAQuestion('2.1 Set question');
    expect(await scoringModalComponentPo.getSectionScoreAndPointsValue('2. Set Title')).toEqual(['NA', 'NA']);
    expect(await scoringModalComponentPo.getCalculatedScore()).toEqual('Calculated weighted score : 67');
    expect(await scoringModalComponentPo.getCurrentPoints()).toEqual('Current points : 2 of 3');
    await scoringModalComponentPo.clickSaveButton();
    await formDesignerPage.saveAndActivateForm(formDetails[0].formName, false);
    await manageFormsPO.waitForSpinnerToDisappear();
    await manageFormsPO.searchFormInGrid(formDetails[0].formName);
    expect((await manageFormsPO.getFormRowElements(formDetails[0].formName)).status).toEqual('Active');

});

Then("should verify section score in test form modal for published form", { timeout: 180 * 1000 }, async () => {
    await manageFormsPO.openParticularForm(formDetails[0].formName);
    await designerToolbarComponentPO.clickOnTestFormButton();
    await testFormModalComponentPo.selectChoices('1.1 Set question', 0);
    await testFormModalComponentPo.selectChoices('1.1 Set question', 0);
    expect(await testFormModalComponentPo.getSectionScore('1. Set Title')).toEqual('Section Score:33.33');
    expect(await testFormModalComponentPo.getSectionScore('2. Set Title')).toEqual('Section Score:NA');
    await testFormModalComponentPo.clickOnValidateButton();
});

Then("should verify section score in form with logic", { timeout: 180 * 1000 }, async () => {
    await await CommonQMNoUIUtils.createForm(formDetails[1], userToken);
    await manageFormsPO.navigate();
    await manageFormsPO.searchFormInGrid(formDetails[1].formName);
    await manageFormsPO.openParticularForm(formDetails[1].formName);
    await designerToolbarComponentPO.clickOnTestFormButton();
    await testFormModalComponentPo.selectChoices('1. Set question', 0);
    expect(await testFormModalComponentPo.getSectionScore('2. Set Title')).toEqual('Section Score:NA');
    expect(await testFormModalComponentPo.getSectionScore('3. Set Title')).toEqual('Section Score:0.00');
    await testFormModalComponentPo.clickOnValidateButton();
});
